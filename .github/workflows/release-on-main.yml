name: Release On Main

on:
  workflow_run:
    workflows:
      - CI
    types:
      - completed

permissions:
  contents: write
  actions: write

jobs:
  release:
    name: Create tag/release and dispatch publishers
    if: >-
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'main' &&
      github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    concurrency:
      group: release-main-${{ github.event.workflow_run.head_sha }}
      cancel-in-progress: false
    steps:
      - name: Checkout tested commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Determine release version
        id: version
        shell: bash
        run: |
          set -euo pipefail

          py_version="$(python3 - <<'PY'
          import tomllib

          with open("pyproject.toml", "rb") as f:
              data = tomllib.load(f)
          print(data["project"]["version"])
          PY
          )"
          npm_version="$(node -p "require('./npm/package.json').version")"

          if [[ "$py_version" != "$npm_version" ]]; then
            echo "Version mismatch: pyproject.toml=$py_version npm/package.json=$npm_version" >&2
            exit 1
          fi

          tag="v$py_version"
          git fetch --tags origin

          if git rev-parse -q --verify "refs/tags/$tag" > /dev/null; then
            should_release="false"
          else
            should_release="true"
          fi

          echo "version=$py_version" >> "$GITHUB_OUTPUT"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "should_release=$should_release" >> "$GITHUB_OUTPUT"

      - name: Create and push release tag
        if: steps.version.outputs.should_release == 'true'
        env:
          TAG: ${{ steps.version.outputs.tag }}
          SHA: ${{ github.event.workflow_run.head_sha }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" "$SHA" -m "Release $TAG"
          git push origin "refs/tags/$TAG"

      - name: Create GitHub Release
        if: steps.version.outputs.should_release == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const tag = "${{ steps.version.outputs.tag }}";
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            try {
              await github.rest.repos.getReleaseByTag({ owner, repo, tag });
              core.info(`Release for ${tag} already exists`);
            } catch (error) {
              if (error.status !== 404) throw error;
              await github.rest.repos.createRelease({
                owner,
                repo,
                tag_name: tag,
                name: tag,
                target_commitish: "${{ github.event.workflow_run.head_sha }}",
                generate_release_notes: true,
                draft: false,
                prerelease: false,
              });
            }

      - name: Dispatch Python publish workflow
        if: steps.version.outputs.should_release == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "release-python.yml",
              ref: "${{ steps.version.outputs.tag }}",
            });

      - name: Dispatch NPM publish workflow
        if: steps.version.outputs.should_release == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "release-npm.yml",
              ref: "${{ steps.version.outputs.tag }}",
            });

      - name: No-op when tag already exists
        if: steps.version.outputs.should_release != 'true'
        run: |
          echo "Release tag ${{ steps.version.outputs.tag }} already exists; skipping."
